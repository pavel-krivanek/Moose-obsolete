(TaCompositionElement>>#copySlot:) removeFromSystem !'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.804.sha.918ec761c0dc17363af6f1cc6320dcfc4919c16f (32 Bit)] on 24 April 2018 at 2:49:02.385088 pm'!!Class methodsFor: '*Monticello' stamp: 'PavelKrivanek 4/24/2018 14:44'!asClassDefinition	"we use a very ugly hack to encode complex slots as string with MC... later MC should model Slots directly"	self usesSpecialVariables ifFalse: [  	 ^MCClassDefinition		name: self name		superclassName: (self superclass ifNil: [ nil asString ] ifNotNil: [ self superclass name ])		traitComposition: self traitCompositionString		classTraitComposition: self class traitCompositionString		category: self category 		instVarNames: self instVarNames		classVarNames: self classVarNames		poolDictionaryNames: self sharedPoolNames		classInstVarNames: self class instVarNames		type: self typeOfClass		comment: self organization classComment	asString		commentStamp: self organization commentStamp].		^MCClassDefinition		name: self name		superclassName: (self superclass ifNil: [ nil asString ] ifNotNil: [ self superclass name ])		traitComposition: self traitCompositionString		classTraitComposition: self class traitCompositionString		category: self category 		instVarNames: (self localSlots collect: #definitionString)		classVarNames: (self classVariables collect: #definitionString)		poolDictionaryNames: self sharedPoolNames		classInstVarNames: (self class localSlots collect: #definitionString)		type: self typeOfClass		comment: self organization classComment	asString		commentStamp: self organization commentStamp.	! !'From Pharo7.0alpha of 23 April 2018 [Build information: Pharo-7.0+alpha.build.800.sha.2e8b99acbf8ea10d9323e82f33ee0ecf6c844cf4 (32 Bit)] on 24 April 2018 at 9:56:51.839856 am'!!ClySourceNodeCritiqueInterval class methodsFor: 'instance creation' stamp: 'PavelKrivanek 4/24/2018 09:55'!from: anInterval	anInterval ifEmpty: [ ^ self new start: 0; stop: 0 ].	^self new 		start: anInterval first;		stop: anInterval last! !		'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.802.sha.83b142c6ac1bee96e43dca44762c3f05b11de0b4 (32 Bit)] on 24 April 2018 at 1:38:01.827577 pm'!!TaAbstractComposition methodsFor: 'copying' stamp: 'PavelKrivanek 4/24/2018 13:22'!copySlot: aSlot	"This is a utitlity method to handle the copy of a slot. It is used for instance side and class side slots."	| newOne |	newOne := aSlot copy.	newOne isVirtual ifFalse: [ newOne index: nil ].	newOne definingClass: aSlot definingClass.	^ newOne! !'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.802.sha.83b142c6ac1bee96e43dca44762c3f05b11de0b4 (32 Bit)] on 24 April 2018 at 1:38:11.512174 pm'!!TaAbstractComposition methodsFor: 'copying' stamp: 'PavelKrivanek 4/24/2018 13:24'!slotsCopy	^ self slots collect: [ :each | self copySlot: each ]! !'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.802.sha.83b142c6ac1bee96e43dca44762c3f05b11de0b4 (32 Bit)] on 24 April 2018 at 1:38:26.730315 pm'!!TaClassCompositionElement methodsFor: 'accessing' stamp: 'PavelKrivanek 4/24/2018 13:23'!slots	^ innerClass slots		reject: [ :e | TraitedClass slots anySatisfy: [ :x | x name = e name ] ]		! !'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.802.sha.83b142c6ac1bee96e43dca44762c3f05b11de0b4 (32 Bit)] on 24 April 2018 at 1:38:37.715511 pm'!!TaCompositionElement methodsFor: 'accessing' stamp: 'PavelKrivanek 4/24/2018 13:23'!slots	^ innerClass slots ! !'From Pharo7.0alpha of 16 April 2018 [Build information: Pharo-7.0+alpha.build.770.sha.807f3fef3c6377f49461afcfec83ae4ea2bd6ddc (32 Bit)] on 17 April 2018 at 10:04:39.220973 am'!!TonelParser methodsFor: 'private factory' stamp: 'PavelKrivanek 4/16/2018 17:03'!newTraitDefinitionFrom: anArray	| metadata traitDefs |	metadata := anArray sixth.		traitDefs := { 		MCTraitDefinition			name: (metadata at: #name)			traitComposition: (metadata at: #traits ifAbsent: [ '{}' ])			category: (metadata at: #category)			instVarNames: (metadata at: #instVars ifAbsent: [ #() ])			comment: (anArray second ifNil: [ '' ])			commentStamp: nil }.				metadata 		at: #classTraits		ifPresent: [ :classTraits |			traitDefs := traitDefs copyWith: (MCClassTraitDefinition 				baseTraitName: (metadata at: #name) 				classTraitComposition: classTraits				category: (metadata at: #category)) ].			^ traitDefs! !'From Pharo7.0alpha of 16 April 2018 [Build information: Pharo-7.0+alpha.build.770.sha.807f3fef3c6377f49461afcfec83ae4ea2bd6ddc (32 Bit)] on 17 April 2018 at 10:05:12.741179 am'!!TonelWriter methodsFor: 'private definitions' stamp: 'PavelKrivanek 4/16/2018 16:48'!typeTraitDefinitionOf: aClassDefinition	| definition |		definition := OrderedDictionary new 		at: #name put: aClassDefinition className; 		yourself.	aClassDefinition hasTraitComposition ifTrue: [ 		definition					at: #traits 			put: aClassDefinition traitCompositionString ].			aClassDefinition hasClassTraitComposition ifTrue: [ 		definition					at: #classTraits 			put: aClassDefinition classTraitCompositionString ].	(aClassDefinition variables select: #isInstanceVariable thenCollect: #name)		ifNotEmpty: [ :vars | definition at: #instVars put: vars asArray ].		definition at: #category put: aClassDefinition category.			^ self toSTON: definition! !'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.804.sha.918ec761c0dc17363af6f1cc6320dcfc4919c16f (32 Bit)] on 24 April 2018 at 2:49:12.599992 pm'!!Trait methodsFor: '*Monticello' stamp: 'PavelKrivanek 4/24/2018 14:44'!asClassDefinition	self usesSpecialVariables ifFalse: [  		^ MCTraitDefinition			name: self name			traitComposition: self traitCompositionString			category: self category 			instVarNames: self instVarNames			comment: self organization classComment asString			commentStamp: self organization commentStamp ].			^ MCTraitDefinition			name: self name			traitComposition: self traitCompositionString			category: self category 			instVarNames: (self localSlots collect: #definitionString)			comment: self organization classComment asString			commentStamp: self organization commentStamp.		! !'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.802.sha.83b142c6ac1bee96e43dca44762c3f05b11de0b4 (32 Bit)] on 24 April 2018 at 1:38:46.197111 pm'!!TraitBuilderEnhancer methodsFor: 'class modifications' stamp: 'PavelKrivanek 4/24/2018 13:24'!configureClass: newClass superclass: superclass withLayoutType: layoutType slots: slots	| resultingSlots |	self validateTraitComposition: self traitComposition ofClass: builder oldClass.	resultingSlots := self		eliminateDuplicates: slots , self traitComposition slotsCopy		withSuperclassSlots: (superclass ifNil: [#()] ifNotNil:[ :x | x allSlots]).	newClass superclass: superclass withLayoutType: layoutType slots: resultingSlots! !'From Pharo7.0alpha of 24 April 2018 [Build information: Pharo-7.0+alpha.build.802.sha.83b142c6ac1bee96e43dca44762c3f05b11de0b4 (32 Bit)] on 24 April 2018 at 1:38:54.584785 pm'!!TraitBuilderEnhancer methodsFor: 'class modifications' stamp: 'PavelKrivanek 4/24/2018 13:24'!configureMetaclass: newMetaclass superclass: superclass withLayoutType: aLayoutType slots: classSlots	| resultingSlots |	self validateTraitComposition: self classTraitComposition ofClass: builder oldMetaclass.	resultingSlots := self		eliminateDuplicates: classSlots , self classTraitComposition slotsCopy		withSuperclassSlots: superclass allSlots.	newMetaclass superclass: superclass withLayoutType: aLayoutType slots: resultingSlots! !'From Pharo7.0alpha of 25 April 2018 [Build information: Pharo-7.0+alpha.build.807.sha.870667407fd7e5b8be085344149bc71203431fc8 (32 Bit)] on 25 April 2018 at 4:48:52.817527 pm'!!TraitedMetaclass methodsFor: 'accessing method dictionary' stamp: 'PavelKrivanek 4/25/2018 16:48'!removeSelector: selector	"When a selector is removed it should be notified to my users.	Check the class TraitChange for more details"	| priorMethod priorProtocol origin oldMethod | 	priorMethod := self compiledMethodAt: selector ifAbsent: [^ nil].	origin := priorMethod origin.	priorProtocol := self whichCategoryIncludesSelector: selector.	self organization removeElement: selector.	oldMethod := self methodDict at: selector ifAbsent: [^ self].	self methodDict removeKey: selector.		self localMethodDict removeKey: selector ifAbsent: [  ].	super removeSelector: selector.	TraitChange removeSelector: selector on: self.		SystemAnnouncer uniqueInstance methodRemoved: priorMethod protocol: priorProtocol origin: origin! !		'From Pharo7.0alpha of 2 May 2018 [Build information: Pharo-7.0+alpha.build.822.sha.9912d7ce669e385f6b6d2542b847ad33833947e9 (32 Bit)] on 2 May 2018 at 2:48:39.097229 pm'!!TaCompositionElement methodsFor: 'accessing' stamp: 'PavelKrivanek 5/2/2018 14:48'!copySlot: aSlot	"This is a utitlity method to handle the copy of a slot. It is used for instance side and class side slots."	| newOne |	newOne := aSlot copy.	newOne isVirtual ifFalse: [ newOne index: nil ].	newOne definingClass: aSlot definingClass.	^ newOne! !		'From Pharo7.0alpha of 2 May 2018 [Build information: Pharo-7.0+alpha.build.822.sha.9912d7ce669e385f6b6d2542b847ad33833947e9 (32 Bit)] on 2 May 2018 at 4:02:44.02697 pm'!'From Pharo7.0alpha of 2 May 2018 [Build information: Pharo-7.0+alpha.build.825.sha.b55e8493c8f0a1877960f5fc50c2f3801b505e74 (32 Bit)] on 3 May 2018 at 11:08:08.629899 am'!!ShLayoutDefinition methodsFor: 'accessing' stamp: 'pk 5/3/2018 11:07'!allSlots	| superclass | 	superclass := builder superclass.	^ (superclass ifNil: [ #() ] ifNotNil: [ superclass allSlots ]) , slots.! !	'From Pharo7.0alpha of 3 May 2018 [Build information: Pharo-7.0+alpha.build.832.sha.0c3ef1f0cd4e0d8cb9883b3244259450bf2503ac (32 Bit)] on 9 May 2018 at 4:26:52.073188 pm'!!TaAbstractComposition methodsFor: 'operations' stamp: 'pk 5/9/2018 16:26'!copyMethod: aSelector into: aClass replacing: replacing	"When the included method does not need to be source rewritten or recompiled, 	it is query by using #changesSourceCode:, the method is inserted in aClass' method dictionary.	The compiled method is just copied and the source is stored in the change file		I check that the method is not already in the class	The method is only replaced if replacing is true. 	"	| aCompiledMethod source newMethod traitDefining |		traitDefining := self traitDefining: aSelector.	aCompiledMethod := self compiledMethodAt: aSelector.	source := self getSourceCodeOf: aCompiledMethod usingSelector: aSelector.		"Check if the method should be replaced. It is replaced if:	 - replacing is true.	 - The trait defining the method is not the same.	 - If both methods have source code and if the source codes are not the same.	"	aClass methodDict at: aSelector ifPresent:[ :originalMethod | 		((replacing not and: [(originalMethod traitSource = traitDefining) and: [originalMethod hasSourceCode]]) and: [ source isNotNil and: [ (source = originalMethod sourceCode) and: [self bytecode = originalMethod bytecode ] ] ]) ifTrue: [ ^ false ]].		newMethod := aCompiledMethod copy.	newMethod selector: aSelector.	newMethod methodClass: aClass.			"write source to changes file only if we have it (not available during bootstrap)"			(source isNotNil and: [((Smalltalk globals includesKey: #SourceFiles) and: [ (Smalltalk globals at: #SourceFiles) notNil])]) ifTrue: [ 		newMethod putSource: source			withPreamble: [:f | f cr; nextPut: $!!; nextChunkPut: 'Trait method'; cr]].	aClass basicAddSelector: aSelector withMethod: newMethod.	aClass organization protocolOrganizer		classify: aSelector		inProtocolNamed: aCompiledMethod category asSymbol.				aClass organization removeEmptyCategories.		aClass >> aSelector propertyAt: #traitSource put: traitDefining.			^ true! !				'From Pharo7.0alpha of 23 April 2018 [Build information: Pharo-7.0+alpha.build.800.sha.2e8b99acbf8ea10d9323e82f33ee0ecf6c844cf4 (32 Bit)] on 24 April 2018 at 11:07:07.470333 am'!!ShiftClassBuilder methodsFor: 'initialization' stamp: 'PavelKrivanek 4/24/2018 10:59'!fillFor: aClass	self		superclass: aClass superclass;		name: aClass getName;		layoutClass: aClass classLayout class;		slots: aClass localSlots;		sharedVariablesFromString: aClass classVariablesString;		sharedPools: aClass sharedPoolsString;		category: aClass category;		environment: aClass environment;		copyClassSlotsFromExistingClass;		oldClass: aClass.			self builderEnhancer fillBuilder: self from: aClass.! !			